#!/usr/bin/env python3
import os, sys, getopt
from magma import compile

try:
    opts, args = getopt.getopt(sys.argv[1:], 'b:o:')
except Exception as e:
    print(e, file=sys.stderr)
    print('usage: magma [-b board]', file=sys.stderr)
    sys.exit(1)

sys.path.append(os.path.dirname(os.path.realpath(args[0])))

name = os.path.basename(args[0])
name = os.path.splitext(name)[0]

board = None
output = "verilog"
for o, a in opts:
    if o == '-b':
        board = a
    if o == '-o':
        output = a

target = None
mantle = None
if board == 'icestick' or board == 'goboard' or board == 'hx8kboard':
    target = 'ice40'
    mantle = 'lattice'

if target:
    os.environ['MANTLE_TARGET'] = target
if mantle:
    os.environ['MANTLE'] = mantle

# Add CWD to PYTHONPATH so Python can find the input file
sys.path.append(os.getcwd())

main = __import__(name).main
mainv = os.path.join('build',name)

compile(mainv, main, output=output)
